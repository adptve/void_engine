# ============================================================================
# BP_PlayerPowerUp - Blueprint Graph Definition
# ============================================================================
# Handles the power surge buff system:
#   - Tracks buff timer
#   - Swaps weapons when buff starts/ends
#   - Updates HUD elements
#   - Plays visual/audio feedback
# ============================================================================

[blueprint]
name = "BP_PlayerPowerUp"
description = "Player power-up handling and weapon swap logic"

# ============================================================================
# VARIABLES
# ============================================================================

[variables]
is_powered_up = { type = "bool", default = false }
power_surge_time = { type = "float", default = 0.0 }
power_surge_duration = { type = "float", default = 15.0 }
base_weapon_id = { type = "string", default = "plasma_rifle" }
powered_weapon_id = { type = "string", default = "plasma_rifle_powered" }

# ============================================================================
# EVENT: On Power Core Collected
# ============================================================================

[[events]]
name = "OnPowerCoreCollected"
description = "Called when player collects a Power Surge Core"

[[events.nodes]]
id = 1
type = "EventNode"
event = "OnPowerCoreCollected"
position = [0, 0]

[[events.nodes]]
id = 2
type = "Branch"
position = [200, 0]
[events.nodes.inputs]
condition = "NOT is_powered_up"  # Don't stack power-ups

# If not already powered up, activate
[[events.nodes]]
id = 3
type = "Sequence"
position = [400, -50]

# Set powered up state
[[events.nodes]]
id = 4
type = "SetVariable"
position = [600, -100]
[events.nodes.params]
variable = "is_powered_up"
value = true

# Set timer
[[events.nodes]]
id = 5
type = "SetVariable"
position = [600, -50]
[events.nodes.params]
variable = "power_surge_time"
value = "power_surge_duration"

# Swap to powered weapon
[[events.nodes]]
id = 6
type = "CallFunction"
position = [600, 0]
[events.nodes.params]
function = "SwapWeapon"
target = "self"
[events.nodes.params.args]
weapon_id = "powered_weapon_id"

# Show power-up UI panel
[[events.nodes]]
id = 7
type = "CallFunction"
position = [600, 50]
[events.nodes.params]
function = "ShowUIElement"
[events.nodes.params.args]
element_id = "powerup_panel"

# Play activation sound
[[events.nodes]]
id = 8
type = "CallFunction"
position = [600, 100]
[events.nodes.params]
function = "PlaySound"
[events.nodes.params.args]
sound = "sounds/powerups/surge_activate.wav"
volume = 1.0

# Apply screen effect
[[events.nodes]]
id = 9
type = "CallFunction"
position = [600, 150]
[events.nodes.params]
function = "PlayScreenEffect"
[events.nodes.params.args]
effect = "effects/power_surge_screen.toml"
duration = 0.5

# Start looping hum sound
[[events.nodes]]
id = 10
type = "CallFunction"
position = [600, 200]
[events.nodes.params]
function = "PlaySoundLoop"
[events.nodes.params.args]
sound = "sounds/powerups/surge_loop.wav"
volume = 0.4
id = "surge_loop"

# Show notification
[[events.nodes]]
id = 11
type = "CallFunction"
position = [600, 250]
[events.nodes.params]
function = "ShowNotification"
[events.nodes.params.args]
type = "powerup"
text = "POWER SURGE ACTIVATED!"
duration = 3.0

# Update stats
[[events.nodes]]
id = 12
type = "CallFunction"
position = [600, 300]
[events.nodes.params]
function = "IncrementState"
[events.nodes.params.args]
variable = "power_ups_collected"
amount = 1

# Connections
[[events.connections]]
from = { node = 1, pin = "exec" }
to = { node = 2, pin = "exec" }

[[events.connections]]
from = { node = 2, pin = "true" }
to = { node = 3, pin = "exec" }

[[events.connections]]
from = { node = 3, pin = "then_0" }
to = { node = 4, pin = "exec" }

[[events.connections]]
from = { node = 3, pin = "then_1" }
to = { node = 5, pin = "exec" }

[[events.connections]]
from = { node = 3, pin = "then_2" }
to = { node = 6, pin = "exec" }

[[events.connections]]
from = { node = 3, pin = "then_3" }
to = { node = 7, pin = "exec" }

[[events.connections]]
from = { node = 3, pin = "then_4" }
to = { node = 8, pin = "exec" }

[[events.connections]]
from = { node = 3, pin = "then_5" }
to = { node = 9, pin = "exec" }

[[events.connections]]
from = { node = 3, pin = "then_6" }
to = { node = 10, pin = "exec" }

[[events.connections]]
from = { node = 3, pin = "then_7" }
to = { node = 11, pin = "exec" }

[[events.connections]]
from = { node = 3, pin = "then_8" }
to = { node = 12, pin = "exec" }

# ============================================================================
# EVENT: Tick - Update Power-Up Timer
# ============================================================================

[[events]]
name = "UpdatePowerUp"
description = "Called every frame to update power-up timer"

[[events.nodes]]
id = 20
type = "EventNode"
event = "on_tick"
position = [0, 400]

# Check if powered up
[[events.nodes]]
id = 21
type = "Branch"
position = [200, 400]
[events.nodes.inputs]
condition = "is_powered_up"

# Decrease timer
[[events.nodes]]
id = 22
type = "SetVariable"
position = [400, 350]
[events.nodes.params]
variable = "power_surge_time"
expression = "power_surge_time - delta_time"

# Check if timer expired
[[events.nodes]]
id = 23
type = "Branch"
position = [600, 350]
[events.nodes.inputs]
condition = "power_surge_time <= 0"

# Timer expired - call end function
[[events.nodes]]
id = 24
type = "CallEvent"
position = [800, 300]
[events.nodes.params]
event = "OnPowerUpEnd"

# Connections
[[events.connections]]
from = { node = 20, pin = "exec" }
to = { node = 21, pin = "exec" }

[[events.connections]]
from = { node = 21, pin = "true" }
to = { node = 22, pin = "exec" }

[[events.connections]]
from = { node = 22, pin = "exec" }
to = { node = 23, pin = "exec" }

[[events.connections]]
from = { node = 23, pin = "true" }
to = { node = 24, pin = "exec" }

# ============================================================================
# EVENT: Power-Up Ended
# ============================================================================

[[events]]
name = "OnPowerUpEnd"
description = "Called when power surge buff expires"

[[events.nodes]]
id = 30
type = "EventNode"
event = "OnPowerUpEnd"
position = [0, 700]

[[events.nodes]]
id = 31
type = "Sequence"
position = [200, 700]

# Reset powered up state
[[events.nodes]]
id = 32
type = "SetVariable"
position = [400, 650]
[events.nodes.params]
variable = "is_powered_up"
value = false

# Reset timer
[[events.nodes]]
id = 33
type = "SetVariable"
position = [400, 700]
[events.nodes.params]
variable = "power_surge_time"
value = 0.0

# Swap back to base weapon
[[events.nodes]]
id = 34
type = "CallFunction"
position = [400, 750]
[events.nodes.params]
function = "SwapWeapon"
target = "self"
[events.nodes.params.args]
weapon_id = "base_weapon_id"

# Hide power-up UI panel
[[events.nodes]]
id = 35
type = "CallFunction"
position = [400, 800]
[events.nodes.params]
function = "HideUIElement"
[events.nodes.params.args]
element_id = "powerup_panel"

# Stop looping sound
[[events.nodes]]
id = 36
type = "CallFunction"
position = [400, 850]
[events.nodes.params]
function = "StopSoundLoop"
[events.nodes.params.args]
id = "surge_loop"

# Play end sound
[[events.nodes]]
id = 37
type = "CallFunction"
position = [400, 900]
[events.nodes.params]
function = "PlaySound"
[events.nodes.params.args]
sound = "sounds/powerups/surge_end.wav"
volume = 0.8

# Show notification
[[events.nodes]]
id = 38
type = "CallFunction"
position = [400, 950]
[events.nodes.params]
function = "ShowNotification"
[events.nodes.params.args]
type = "powerup"
text = "Power Surge ended"
duration = 2.0

# Connections
[[events.connections]]
from = { node = 30, pin = "exec" }
to = { node = 31, pin = "exec" }

[[events.connections]]
from = { node = 31, pin = "then_0" }
to = { node = 32, pin = "exec" }

[[events.connections]]
from = { node = 31, pin = "then_1" }
to = { node = 33, pin = "exec" }

[[events.connections]]
from = { node = 31, pin = "then_2" }
to = { node = 34, pin = "exec" }

[[events.connections]]
from = { node = 31, pin = "then_3" }
to = { node = 35, pin = "exec" }

[[events.connections]]
from = { node = 31, pin = "then_4" }
to = { node = 36, pin = "exec" }

[[events.connections]]
from = { node = 31, pin = "then_5" }
to = { node = 37, pin = "exec" }

[[events.connections]]
from = { node = 31, pin = "then_6" }
to = { node = 38, pin = "exec" }

# ============================================================================
# EVENT: On Target Destroyed (Score Points)
# ============================================================================

[[events]]
name = "OnTargetDestroyed"
description = "Called when a target dummy is destroyed - adds score"

[[events.nodes]]
id = 40
type = "EventNode"
event = "OnTargetDestroyed"
position = [0, 1100]
[events.nodes.outputs]
target_entity = "Entity"
points_value = "int"

[[events.nodes]]
id = 41
type = "Sequence"
position = [200, 1100]

# Add score
[[events.nodes]]
id = 42
type = "CallFunction"
position = [400, 1050]
[events.nodes.params]
function = "AddToState"
[events.nodes.params.args]
variable = "score"
amount = "points_value"

# Increment kill counter
[[events.nodes]]
id = 43
type = "CallFunction"
position = [400, 1100]
[events.nodes.params]
function = "IncrementState"
[events.nodes.params.args]
variable = "enemies_destroyed"
amount = 1

# Play destroy sound
[[events.nodes]]
id = 44
type = "CallFunction"
position = [400, 1150]
[events.nodes.params]
function = "PlaySoundAtLocation"
[events.nodes.params.args]
sound = "sounds/impacts/target_destroy.wav"
location = "target_entity.position"
volume = 0.8

# Show notification
[[events.nodes]]
id = 45
type = "CallFunction"
position = [400, 1200]
[events.nodes.params]
function = "ShowNotification"
[events.nodes.params.args]
type = "kill"
text = "+{points_value} points!"
duration = 1.5

# Connections
[[events.connections]]
from = { node = 40, pin = "exec" }
to = { node = 41, pin = "exec" }

[[events.connections]]
from = { node = 41, pin = "then_0" }
to = { node = 42, pin = "exec" }

[[events.connections]]
from = { node = 41, pin = "then_1" }
to = { node = 43, pin = "exec" }

[[events.connections]]
from = { node = 41, pin = "then_2" }
to = { node = 44, pin = "exec" }

[[events.connections]]
from = { node = 41, pin = "then_3" }
to = { node = 45, pin = "exec" }
